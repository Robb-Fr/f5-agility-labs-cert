<!DOCTYPE html>
<head>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPZPQ6');</script>
  <!-- End Google Tag Manager -->
    <title>F5N2 - Configuration: Knowledge</title>
  

  <meta charset="utf-8">
  <!-- Twitter Bootstrap viewport setting -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- F5 metadata -->
  <meta name="title" content="F5N2 - Configuration: Knowledge"/>
  <meta name="product" content="Unofficial - F5 Certification Exam Prep Material"/>
  <meta name="version" content=""/>
  <meta name="updated_date"  content="2024-08-21 02:53:55"/>
  <meta name="archived" content="Archived documents excluded"/>
  <meta name="doc_type" content="Manual"/>
  <meta name="lifecycle" content="release"/>
  <meta name="Unofficial - F5 Certification Exam Prep Material" content=""/>


  

  
  <link href="https://cdn.f5.com/favicon.ico" rel="icon">

</head>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>F5N2 - Configuration: Knowledge &#8212; Unofficial - F5 Certification Exam Prep Material  documentation</title>
    <link rel="stylesheet" href="../../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5-theme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/CoveoFullSearch.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://use.fontawesome.com/21fb8a09c3.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/clipboard.min.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="F5N3 - Configuration: Demonstrate" href="module3.html" />
    <link rel="prev" title="F5N1 - Management" href="module1.html" /> 
  </head><body>
  <div id="clouddocs-header"></div>

    <div id="sidebar" class="section-nav">
      
      <!--  version selector ------------------>
      <div id="version_selector_wrapper">
      </div>
      <nav class="nav-sidebartoc">

        
         <h5>Unofficial - F5 Certification Exam Prep Material  </h5>
        

        <hr>
        <span class="nav-sidebartoc">
            <p class="caption"><span class="caption-text">Intro:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Getting Started with the F5 Certification Program - Created 03/29/19</a></li>
</ul>
<p class="caption"><span class="caption-text">Unofficial - 101 Certification Exam Resources:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../class1/class1.html">F5 101 - App Delivery Fundamentals Exam Study Guide - Created 03/06/20</a></li>
</ul>
<p class="caption"><span class="caption-text">Unofficial - 201 Certification Exam Resources:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../class3/class3.html">F5 201 - TMOS Administration Exam Study Guide - New One Not Created Yet</a></li>
</ul>
<p class="caption"><span class="caption-text">Unofficial - 201 Certification Lab:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../class4/class4.html">F5 201 - TMOS Administration Labs (V13.1)</a></li>
</ul>
<p class="caption"><span class="caption-text">Unofficial - 202 Certification Exam Resources:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../class5/class5.html">F5 202 - Pre-Sales Fundamentals Exam Study Guide - Created 11/01/19</a></li>
</ul>
<p class="caption"><span class="caption-text">Unofficial - 301A Certification Exam Resources:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../class7/class7.html">F5 301A - BIG-IP LTM Specialist: Architect, Set-Up &amp; Deploy Exam Study Guide - Created 11/01/19</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class8/class8.html">F5 301A - BIG-IP LTM Specialist Labs - Created 11/01/19</a></li>
</ul>
<p class="caption"><span class="caption-text">Unofficial - 301B Certification Exam Resources:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../class9/class9.html">F5 301B - BIG-IP LTM Specialist: Maintain and Troubleshoot Exam Study Guide - Created 11/01/19</a></li>
</ul>
<p class="caption"><span class="caption-text">Unofficial - 302 Certification Exam Resources:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../class11/class11.html">F5 302 - BIG-IP DNS Specialist Exam Study Guide - NOT CREATED</a></li>
</ul>
<p class="caption"><span class="caption-text">Unofficial - 303 Certification Exam Resources:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../class13/class13.html">F5 303 - BIG-IP ASM Specialist Study Guide - NOT CREATED</a></li>
</ul>
<p class="caption"><span class="caption-text">Unofficial - 304 Certification Exam Resources:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../class15/class15.html">F5 304 - BIG-IP APM Specialist Study Guide - NOT CREATED</a></li>
</ul>
<p class="caption"><span class="caption-text">Unofficial - 401 Certification Exam Resources:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../class17/class17.html">F5 401 - Security Solution Expert Study Guide - Created 09/26/18</a></li>
</ul>
<p class="caption"><span class="caption-text">Unofficial - 402 Certification Exam Resources:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../class19/class19.html">F5 402 - Cloud Solutions Study Guide - NOT CREATED</a></li>
</ul>
<p class="caption"><span class="caption-text">Unofficial - Nginx OSS Certification Exam Resources:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../class21.html">F5 N1-N4 - NGINX OSS - NOT CREATED</a></li>
</ul>

        </span><!-- Use this file to add extra links to the bottom of the ToC sidebar -->
<hr>
  <span class="nav-sidebartoc">
 <!-- insert content here -->
  </span>
      </nav>
    </div>


    <div id="right-sidebar">
      <h7 style="font-weight:normal">On this page:</h7>
      <nav class="nav-sidebartoc">
        <span class="nav-sidebartoc">
            <ul>
<li><a class="reference internal" href="#">F5N2 - Configuration: Knowledge</a><ul>
<li><a class="reference internal" href="#objective-1-1-configure-nginx-as-a-load-balancer">Objective - 1.1 Configure NGINX as a load balancer</a><ul>
<li><a class="reference internal" href="#define-the-load-balancing-pools-systems">1.1 - Define the load balancing pools/systems</a></li>
<li><a class="reference internal" href="#explain-the-different-load-balancing-algorithms">1.1 - Explain the different load balancing algorithms</a></li>
<li><a class="reference internal" href="#describe-the-process-used-to-remove-a-server-from-the-pool">1.1 - Describe the process used to remove a server from the pool</a></li>
<li><a class="reference internal" href="#describe-what-happens-when-a-pool-server-goes-down">1.1 - Describe what happens when a pool server goes down</a></li>
<li><a class="reference internal" href="#explain-what-is-unique-to-nginx-as-a-load-balancer">1.1 - Explain what is unique to NGINX as a load balancer</a></li>
<li><a class="reference internal" href="#describe-how-to-configure-security">1.1 - Describe how to configure security</a></li>
<li><a class="reference internal" href="#modify-or-tune-a-memory-zone-configuration">1.1 - Modify or tune a memory zone configuration</a></li>
<li><a class="reference internal" href="#describe-how-to-configure-nginx-as-mirroring-server">1.1 - Describe how to configure NGINX as mirroring server</a></li>
<li><a class="reference internal" href="#describe-how-to-configure-nginx-as-a-layer-4-load-balancer">1.1 - Describe how to configure NGINX as a layer 4 load balancer</a></li>
<li><a class="reference internal" href="#describe-how-to-configure-nginx-as-an-api-gateway">1.1 - Describe how to configure NGINX as an API Gateway</a></li>
</ul>
</li>
<li><a class="reference internal" href="#objective-1-2-configure-nginx-as-a-content-cache-server">Objective - 1.2 Configure NGINX as a content cache server</a><ul>
<li><a class="reference internal" href="#define-a-minimum-retention-policy">1.2 - Define a minimum retention policy</a></li>
<li><a class="reference internal" href="#describe-how-to-configure-path-regex-routing">1.2 - Describe how to configure path REGEX routing</a></li>
<li><a class="reference internal" href="#describe-the-why-and-how-of-caching-in-nginx">1.2 - Describe the why and how of caching in NGINX</a></li>
<li><a class="reference internal" href="#define-the-cache-in-the-http-context">1.2 - Define the cache in the http context</a></li>
<li><a class="reference internal" href="#enable-the-cache">1.2 - Enable the cache</a></li>
<li><a class="reference internal" href="#specify-the-content-that-should-be-cached">1.2 - Specify the content that should be cached</a></li>
<li><a class="reference internal" href="#describe-different-types-of-caching">1.2 - Describe different types of caching</a></li>
<li><a class="reference internal" href="#explain-what-is-unique-to-nginx-as-a-cache-server">1.2 - Explain what is unique to NGINX as a cache server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#objective-1-3-configure-nginx-as-a-web-server">Objective - 1.3 Configure NGINX as a web server</a><ul>
<li><a class="reference internal" href="#demonstrate-how-to-securely-serve-content-http-https">1.3 - Demonstrate how to securely serve content (HTTP/HTTPS)</a></li>
<li><a class="reference internal" href="#describe-the-difference-between-serving-static-content-and-dynamic-content-regex-and-variables">1.3 - Describe the difference between serving static content and dynamic content. (REGEX, and variables)</a></li>
<li><a class="reference internal" href="#describe-how-server-and-location-work">1.3 - Describe how server and location work</a></li>
<li><a class="reference internal" href="#explain-what-is-unique-to-nginx-as-a-web-server">1.3 - Explain what is unique to NGINX as a web server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#objective-configure-nginx-as-a-reverse-proxy">Objective - Configure NGINX as a reverse proxy</a><ul>
<li><a class="reference internal" href="#explain-how-traffic-routing-is-handled-in-nginx-as-a-reverse-proxy">1.4 - Explain how traffic routing is handled in NGINX as a reverse proxy</a></li>
<li><a class="reference internal" href="#explain-what-is-unique-to-nginx-as-a-reverse-proxy">1.4 - Explain what is unique to NGINX as a reverse proxy</a></li>
<li><a class="reference internal" href="#configure-encryption">1.4 - Configure encryption</a></li>
<li><a class="reference internal" href="#demonstrate-how-to-manipulate-headers">1.4 - Demonstrate how to manipulate headers</a></li>
<li><a class="reference internal" href="#describe-the-difference-between-proxy-set-header-and-add-header">1.4 - Describe the difference between proxy_set_header and add_header</a></li>
<li><a class="reference internal" href="#id1">1.4 - Modify or tune a memory zone configuration</a></li>
<li><a class="reference internal" href="#describe-how-to-configure-nginx-as-socket-reserve-proxy">1.4 - Describe how to configure NGINX as socket reserve proxy</a></li>
<li><a class="reference internal" href="#describe-how-open-source-nginx-handles-health-checks-in-different-situations">1.4 - Describe how open source NGINX handles health checks in different situations</a></li>
</ul>
</li>
</ul>
</li>
</ul>

         </span>
      </nav>
    </div>





  
  <div class="main active" id="content" >
    <article class="docs-container site-article-inner">
              <!-- custom breadcrumb -->
        <h5>
            <a href="../../index.html">Unofficial - F5 Certification Exam Prep Material</a>
              &gt; <a href="../class21.html">F5 N1-N4 - NGINX OSS - NOT CREATED</a>

          <span class="right">
             <a href="../../_sources/class21/modules/module2.rst.txt" rel="nofollow">Source</a> |
             <a href="https://github.com/f5devcentral/f5-agility-labs-cert">Edit on <i class="fa fa-github" aria-hidden="true"></i></a>
          </span>
        </h5>
        <!-- end custom breadcrumb -->
      


    <!--a title="Export PDF" id="export-pdf" class="btn btn btn-link pull-right">View PDF</a-->
    <button type="button" id="export-pdf" class="btn btn-link right">PDF</button>


    
     
         <div class="sidebar" id="version-warning" style="display: none;">
           <p class="first sidebar-title">
           <span class="icon fa fa-info-circle fa-lg"></span> Version notice:</p>
           <p class="last" id="currentVersion"></p>
          </div>


     <div role="main">
        
  <div class="section" id="f5n2-configuration-knowledge">
<h1>F5N2 - Configuration: Knowledge<a class="headerlink" href="#f5n2-configuration-knowledge" title="Permalink to this headline">¶</a></h1>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<p><em>TODO</em></p>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<div class="section" id="objective-1-1-configure-nginx-as-a-load-balancer">
<h2>Objective - 1.1 Configure NGINX as a load balancer<a class="headerlink" href="#objective-1-1-configure-nginx-as-a-load-balancer" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<div class="section" id="define-the-load-balancing-pools-systems">
<h3>1.1 - Define the load balancing pools/systems<a class="headerlink" href="#define-the-load-balancing-pools-systems" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://nginx.org/en/docs/http/load_balancing.html">http://nginx.org/en/docs/http/load_balancing.html</a></p>
<p><a class="reference external" href="https://docs.nginx.com/nginx/admin-guide/load-balancer/tcp-udp-load-balancer/">https://docs.nginx.com/nginx/admin-guide/load-balancer/tcp-udp-load-balancer/</a></p>
<p><strong>upstream directive</strong></p>
<p>Defining a load balancing pool is as simple as writing the <code class="docutils literal notranslate"><span class="pre">upstream</span></code>
directive in an <code class="docutils literal notranslate"><span class="pre">http</span></code> or <code class="docutils literal notranslate"><span class="pre">stream</span></code> block. Please refer to the referenced
pages for details.</p>
<blockquote>
<div>The simplest configuration for load balancing with nginx may look like the
following:</div></blockquote>
<div class="highlight-NGINX notranslate"><div class="highlight"><pre><span></span><span class="k">http</span> <span class="p">{</span>
    <span class="kn">upstream</span> <span class="s">myapp1</span> <span class="p">{</span>
        <span class="kn">server</span> <span class="s">srv1.example.com</span><span class="p">;</span>
        <span class="kn">server</span> <span class="s">srv2.example.com</span><span class="p">;</span>
        <span class="kn">server</span> <span class="s">srv3.example.com</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">server</span> <span class="p">{</span>
        <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>

        <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
            <span class="kn">proxy_pass</span> <span class="s">http://myapp1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the example above, there are 3 instances of the same application running on
srv1-srv3. When the load balancing method is not specifically configured, it
defaults to round-robin. All requests are proxied to the server group myapp1,
and nginx applies HTTP load balancing to distribute the requests.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="explain-the-different-load-balancing-algorithms">
<h3>1.1 - Explain the different load balancing algorithms<a class="headerlink" href="#explain-the-different-load-balancing-algorithms" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/#choosing-a-load-balancing-method">https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/#choosing-a-load-balancing-method</a></p>
<p><strong>Different algorithms for different needs</strong></p>
<p>The referenced resource explains in details each algorithm. The algorithms
available in NGINX OSS are the following:</p>
<ul class="simple">
<li>default: round-robin</li>
<li>least connections with <code class="docutils literal notranslate"><span class="pre">least_conn</span></code></li>
<li>ip hash with <code class="docutils literal notranslate"><span class="pre">ip_hash</span></code></li>
<li>generic hash with <code class="docutils literal notranslate"><span class="pre">hash</span></code></li>
<li>random with <code class="docutils literal notranslate"><span class="pre">random</span></code></li>
</ul>
<p>Note that for these methods, one can also define a <code class="docutils literal notranslate"><span class="pre">weight</span></code> parameter, that
influence some server over others when making the upstream server choice with a
defined weight.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="describe-the-process-used-to-remove-a-server-from-the-pool">
<h3>1.1 - Describe the process used to remove a server from the pool<a class="headerlink" href="#describe-the-process-used-to-remove-a-server-from-the-pool" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-health-check/#passive-health-checks">https://docs.nginx.com/nginx/admin-guide/load-balancer/http-health-check/#passive-health-checks</a></p>
<p><a class="reference external" href="https://nginx.org/en/docs/http/load_balancing.html">https://nginx.org/en/docs/http/load_balancing.html</a></p>
<p><a class="reference external" href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#server">https://nginx.org/en/docs/http/ngx_http_upstream_module.html#server</a></p>
<p><strong>Manually remove a server from a pool</strong></p>
<p>Let us say you have an upstream pool such as the one showed in the following
configuration file:</p>
<div class="highlight-NGINX notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">upstream</span> <span class="s">backend</span> <span class="p">{</span>
    <span class="kn">server</span> <span class="s">backend1.example.com</span><span class="p">;</span>
    <span class="kn">server</span> <span class="n">backend2.example.com</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
    <span class="kn">server</span> <span class="n">backend2.example.com</span><span class="p">:</span><span class="mi">8081</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>You may want to perform some maintenance on the server <code class="docutils literal notranslate"><span class="pre">backend1.example.com</span></code>
and therefore, temporarily remove it from the pool. Removing the line 2 and
reloading the configuration file with <code class="docutils literal notranslate"><span class="pre">nginx</span> <span class="pre">-s</span> <span class="pre">reload</span></code> will make NGINX not
choose this upstream server for any new incoming connection. Another cleaner
possibility would be to use the <code class="docutils literal notranslate"><span class="pre">down</span></code> option such as:</p>
<div class="highlight-NGINX notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">upstream</span> <span class="s">backend</span> <span class="p">{</span>
<span class="hll">    <span class="kn">server</span> <span class="s">backend1.example.com</span> <span class="s">down</span><span class="p">;</span>
</span>    <span class="kn">server</span> <span class="n">backend2.example.com</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
    <span class="kn">server</span> <span class="n">backend2.example.com</span><span class="p">:</span><span class="mi">8081</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Where you perform a minimal alteration on your file. Note that this may lead to
connection loss for clients that were proxied to the backend1 server when you
run the configuration reload command.</p>
<p id="health-check"><strong>Automatic removal with passive health checks</strong></p>
<p>NGINX also manages automatic removal of pool members using the passive health
checks. If the response from a particular server fails with an error, nginx
will mark this server as failed, and will try to avoid selecting this server
for subsequent inbound requests for a while.</p>
<p>The max_fails directive sets the number of consecutive unsuccessful attempts to
communicate with the server that should happen during fail_timeout. By default,
max_fails is set to 1. When it is set to 0, health checks are disabled for this
server. The fail_timeout parameter also defines how long the server will be
marked as failed. After fail_timeout interval following the server failure,
nginx will start to gracefully probe the server with the live client’s
requests. If the probes have been successful, the server is marked as a live
one.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="describe-what-happens-when-a-pool-server-goes-down">
<h3>1.1 - Describe what happens when a pool server goes down<a class="headerlink" href="#describe-what-happens-when-a-pool-server-goes-down" title="Permalink to this headline">¶</a></h3>
<p>This aspect is covered in the previous part on <a class="reference internal" href="#health-check">health check</a>.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="explain-what-is-unique-to-nginx-as-a-load-balancer">
<h3>1.1 - Explain what is unique to NGINX as a load balancer<a class="headerlink" href="#explain-what-is-unique-to-nginx-as-a-load-balancer" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://www.f5.com/company/events/webinars/nginx-plus-for-load-balancing-30-min">https://www.f5.com/company/events/webinars/nginx-plus-for-load-balancing-30-min</a>
(from 6:40 to 10:20 notably)</p>
<p><strong>What are the other load balancing methods</strong></p>
<dl class="docutils">
<dt>DNS Rounds Robin</dt>
<dd><p class="first">This method is quite simple and can be easily and cheaply configured: to
load balance between 3 servers with 3 different IPs, the DNS record for the
service (example.com for example) is configured to one element among an
array of 3 IP addresses. Clients, receiving these, will contact the server
with the received IP address, allowing to distribute load among clients as
long as the DNS server returns different results to different clients.</p>
<p class="last">However, this lacks on the update speed: updating DNS records can take time
and a server that is down may be served to some client for a long time.
Also, this method does not scale well as it requires managing every growing
DNS records which can be complicated.</p>
</dd>
<dt>Hardware L4 load balancer</dt>
<dd>These are advanced network switches that do not handle a full TCP stack but
stream TCP packets and track the TCP sessions using the attributes they
find in the TCP header. They deliver great performances but are limited in
terms of available features: out of order and broken TCP packets are not
easy to handle and lead to a reduced flexibility.</dd>
<dt>Cloud solutions</dt>
<dd>Cloud providers often provide their own load balancing systems (Amazon’s
Elastic Load Balancer for example). However, these totally depend on the
exposed interface from the Cloud provider’s system, potentially giving a
lower flexibility.</dd>
</dl>
<p><strong>Where NGINX stands and what challenges it can overcome</strong></p>
<p>NGINX is in the category of the Software load balancer. This refers to reverse
proxy systems: these are software applications running on machines having their
own full TCP stack (Linux or FreeBSD machines for example). The particularity
is that it terminates the TCP connection and handles it. It afterward processes
the content of the connection as desired, and reopen a TCP connection to the
upstream server, using any implementable software method to load balance
between different servers. This gives the maximum degree of flexibility to
control the received connection and stream and apply logic to ensure
performance and security.</p>
<p>For example, with NGINX, one can perform load balancing depending on HTTP
content (session cookies, request URIs, …) as the reverse proxy terminates
the TCP connection, it has the ability to use any L4-L7 information to perform
load balancing decision.</p>
<p>Also, NGINX being implemented using low level performant C code, it benefits
from excellent performances despite being software based, which is a key aspect
to efficient load balancing.</p>
<p>The following diagrams picture the different ideologies between the different
types of load balancers.</p>
<a class="reference internal image-reference" href="../../_images/load-balancers-dns.excalidraw.svg"><div align="center" class="align-center"><img alt="Diagram load balancer DNS" src="../../_images/load-balancers-dns.excalidraw.svg" width="1200px" /></div>
</a>
<a class="reference internal image-reference" href="../../_images/load-balancers-l4.excalidraw.svg"><div align="center" class="align-center"><img alt="Diagram load balancer L4" src="../../_images/load-balancers-l4.excalidraw.svg" width="1200px" /></div>
</a>
<a class="reference internal image-reference" href="../../_images/load-balancers-software.excalidraw.svg"><div align="center" class="align-center"><img alt="Diagram software load balancer" src="../../_images/load-balancers-software.excalidraw.svg" width="1200px" /></div>
</a>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="describe-how-to-configure-security">
<span id="module2-describe-configure-security"></span><h3>1.1 - Describe how to configure security<a class="headerlink" href="#describe-how-to-configure-security" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://docs.nginx.com/nginx/admin-guide/security-controls/">https://docs.nginx.com/nginx/admin-guide/security-controls/</a></p>
<p><a class="reference external" href="https://docs.nginx.com/nginx/admin-guide/monitoring/logging/">https://docs.nginx.com/nginx/admin-guide/monitoring/logging/</a></p>
<p><strong>L4-L7 security</strong></p>
<p>This given objective may sound quite vague, and it is not clear why it stands
in this section about load balancing as it could be a section in itself.
Considering this, the reader is advised to be familiar with all the NGINX
security controls available in NGINX OSS that we will list here and are
detailed in the linked documentation.</p>
<ul class="simple">
<li>NGINX as an HTTPS/SSL server: NGINX can handle and terminate TLS/SSL
communications. The simple default but customizable at will principle also
applies here: 3 directives allow setting up NGINX as an HTTPS reverse proxy
load balancer, but other options can be enabled (mTLS, OCSP, SNI
validation…). Note these are available in <code class="docutils literal notranslate"><span class="pre">http</span> <span class="pre">{}</span></code> and <code class="docutils literal notranslate"><span class="pre">stream</span> <span class="pre">{}</span></code>
blocks.</li>
<li>NGINX as a perimeter authentication system: NGINX supports authentication
protocols (limited in NGINX OSS) to ensure the desired <code class="docutils literal notranslate"><span class="pre">server</span> <span class="pre">{}</span></code> or
<code class="docutils literal notranslate"><span class="pre">location</span> <span class="pre">{}</span></code> blocks are protected and authenticated.</li>
<li>Rate/bandwidth control: NGINX can be configured to limit the request
rate/amount or the served bandwidth to some clients to prevent abuses.</li>
<li>IP based restrictions: NGINX can restrict access to some routes or some
servers based on the client’s IP.</li>
<li>NGINX as an HTTPS/SSL client: NGINX can finally handle secured connections to
upstream servers with again, simple defaults and some granular control to
enable options.</li>
</ul>
<p>Also, considering observability as a security property, take note of the
logging configuration of NGINX, notably its centralisation capabilities with
easy to configure log sending to a syslog server.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="modify-or-tune-a-memory-zone-configuration">
<h3>1.1 - Modify or tune a memory zone configuration<a class="headerlink" href="#modify-or-tune-a-memory-zone-configuration" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_limit_conn_module.html#limit_conn_zone">http://nginx.org/en/docs/http/ngx_http_limit_conn_module.html#limit_conn_zone</a></p>
<p><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_limit_req_module.html#limit_req_zone">http://nginx.org/en/docs/http/ngx_http_limit_req_module.html#limit_req_zone</a></p>
<p><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_js_module.html#js_shared_dict_zone">http://nginx.org/en/docs/http/ngx_http_js_module.html#js_shared_dict_zone</a></p>
<p><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path">http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path</a></p>
<p><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#zone">http://nginx.org/en/docs/http/ngx_http_upstream_module.html#zone</a></p>
<p><strong>Memory zones in NGINX</strong></p>
<p>When configuring memory zones in NGINX, we generally refer to shared memory
zones, as seen and explained in <a class="reference internal" href="module1.html#module1-shared-memory-zones"><span class="std std-ref">the previous module</span></a>. To modify or tune these, we must first identify where they
appear in our NGINX configurations. In NGINX OSS, shared memory zones can be
configured in the following contexts:</p>
<ul class="simple">
<li>The connection limiting: sharing across worker the state of clients
regarding the amount of connection requests.</li>
<li>The request limiting: sharing across worker the state of clients regarding
the amount and nature of HTTP requests.</li>
<li>The JavaScript shared dictionary: sharing across workers JS structures in the
form of dictionary.</li>
<li>The proxy caching: sharing across workers the key/value pairs associating
requests parameters with cached content location on the disk.</li>
<li>The upstream pools: sharing across workers the state of upstream services of
pools for updating their status (alive, down, served X times, …)</li>
</ul>
<p><strong>What can be configured and tuned</strong></p>
<p>In each of the aforementioned contexts, different directives allow to configure
the shared memory zones corresponding. For most of these, this zone has only 2
parameters: a name (used to identify a same zone multiple times in the config),
and a size in bytes.</p>
<p>The size parameter can be tuned and engineered to correspond to the nature of
the application and the server’s resources. For example, knowing that a shared
JS dictionary should only have a few small entries, on can allocate only a few
kilobytes preventing the allocation of megabytes of memory and not using it.</p>
<p>For details on the different syntaxes, the reader should refer to the mentioned
links to the documentation.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="describe-how-to-configure-nginx-as-mirroring-server">
<h3>1.1 - Describe how to configure NGINX as mirroring server<a class="headerlink" href="#describe-how-to-configure-nginx-as-mirroring-server" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://alex.dzyoba.com/blog/nginx-mirror/">https://alex.dzyoba.com/blog/nginx-mirror/</a></p>
<p><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_mirror_module.html">http://nginx.org/en/docs/http/ngx_http_mirror_module.html</a></p>
<p><a class="reference external" href="https://thelinuxnotes.com/index.php/mirroring-requests-to-another-server-with-nginx/">https://thelinuxnotes.com/index.php/mirroring-requests-to-another-server-with-nginx/</a></p>
<p><strong>The concept of mirroring requests in NGINX</strong></p>
<p>In the context of reverse proxying, request mirroring refers to making the
reverse proxy, proxy requests to a mirroring server, “as if” it was an actual
backend upstream server. However, the specificity lies in the fact that NGINX
does not actually forward the mirror server’s response back to the client. This
for example allows to test a new, off-production backend server with real
clients’ requests and assess its functionalities before pushing it to
production.</p>
<p>The following diagram from <a class="reference external" href="https://alex.dzyoba.com/blog/nginx-mirror/">Alex Dzyoba’s
blog</a> provides a visual
representation of a mirroring setup where NGINX would both, proxy the actual
client’s request to the real backend server, as well as mirroring this request
to a test server.</p>
<a class="reference internal image-reference" href="../../_images/nginx-mirror-mirror-setup.png"><img alt="Diagram of a mirroring server setup with NGINX" src="../../_images/nginx-mirror-mirror-setup.png" style="height: 400px;" /></a>
<p><strong>Configure NGINX to mirror requests</strong></p>
<p>NGINX uses the directives from the <code class="docutils literal notranslate"><span class="pre">ngx_http_mirror_module</span></code> to implement the
mirroring.</p>
<p>The following configuration defines 2 locations: the first where NGINX should:</p>
<ol class="arabic simple">
<li>mirror the client’s request to its <code class="docutils literal notranslate"><span class="pre">/mirror</span></code> URI</li>
<li>proxy the request to the real backend, picked from the upstream pool named
<code class="docutils literal notranslate"><span class="pre">backend</span></code>.</li>
</ol>
<p>The second location is internal (meaning it can only be reached by NGINX
itself, not from the outside), and defines what should happen to the requests
made to the <code class="docutils literal notranslate"><span class="pre">/mirror</span></code> endpoint. They should be proxied to another backend,
picked from the <code class="docutils literal notranslate"><span class="pre">test_backend</span></code> pool.</p>
<div class="highlight-NGINX notranslate"><div class="highlight"><pre><span></span><span class="k">location</span> <span class="s">/</span> <span class="p">{</span>
    <span class="kn">mirror</span> <span class="s">/mirror</span><span class="p">;</span>
    <span class="kn">proxy_pass</span> <span class="s">http://backend</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">location</span> <span class="p">=</span> <span class="s">/mirror</span> <span class="p">{</span>
    <span class="kn">internal</span><span class="p">;</span>
    <span class="kn">proxy_pass</span> <span class="s">http://test_backend</span><span class="nv">$request_uri</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="describe-how-to-configure-nginx-as-a-layer-4-load-balancer">
<h3>1.1 - Describe how to configure NGINX as a layer 4 load balancer<a class="headerlink" href="#describe-how-to-configure-nginx-as-a-layer-4-load-balancer" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://docs.nginx.com/nginx/admin-guide/load-balancer/tcp-udp-load-balancer/">https://docs.nginx.com/nginx/admin-guide/load-balancer/tcp-udp-load-balancer/</a></p>
<p><strong>TCP/UDP load balancing</strong></p>
<p>In the same fashion as NGINX can be configured as a Layer 7 (HTTP) load
balancer, the same can be done at the Layer 4 with a similar syntax: one must
configure an upstream servers group with the <code class="docutils literal notranslate"><span class="pre">upstream</span></code> directive and can
afterward use the <code class="docutils literal notranslate"><span class="pre">proxy_pass</span></code> directive to proxy the requests at layer 4 to
the upstream pool.</p>
<p>The following configuration defines an upstream pool composed of 3 servers: the
first 3 are active while the last 2 are backup (they receive requests only when
one of the active server is down). The first server is preferred in the load
balancing algorithm by a factor of 5. The load balancing algorithm uses the
hash algorithm by taking the remote client’s address as a key.</p>
<div class="highlight-NGINX notranslate"><div class="highlight"><pre><span></span><span class="k">upstream</span> <span class="s">backend</span> <span class="p">{</span>
    <span class="kn">hash</span> <span class="nv">$remote_addr</span><span class="p">;</span>

    <span class="kn">server</span> <span class="n">backend1.example.com</span><span class="p">:</span><span class="mi">12345</span>  <span class="s">weight=5</span><span class="p">;</span>
    <span class="kn">server</span> <span class="n">backend2.example.com</span><span class="p">:</span><span class="mi">12345</span><span class="p">;</span>
    <span class="kn">server</span> <span class="s">unix:/tmp/backend3</span><span class="p">;</span>

    <span class="kn">server</span> <span class="n">backup1.example.com</span><span class="p">:</span><span class="mi">12345</span>   <span class="s">backup</span><span class="p">;</span>
    <span class="kn">server</span> <span class="n">backup2.example.com</span><span class="p">:</span><span class="mi">12345</span>   <span class="s">backup</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">12346</span><span class="p">;</span>
    <span class="kn">proxy_pass</span> <span class="s">backend</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="describe-how-to-configure-nginx-as-an-api-gateway">
<h3>1.1 - Describe how to configure NGINX as an API Gateway<a class="headerlink" href="#describe-how-to-configure-nginx-as-an-api-gateway" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://www.f5.com/company/blog/nginx/deploying-nginx-plus-as-an-api-gateway-part-1">https://www.f5.com/company/blog/nginx/deploying-nginx-plus-as-an-api-gateway-part-1</a></p>
<p><a class="reference external" href="https://www.f5.com/company/blog/nginx/deploying-nginx-plus-as-an-api-gateway-part-2-protecting-backend-services">https://www.f5.com/company/blog/nginx/deploying-nginx-plus-as-an-api-gateway-part-2-protecting-backend-services</a></p>
<p><a class="reference external" href="https://www.f5.com/company/blog/nginx/deploying-nginx-plus-as-an-api-gateway-part-3-publishing-grpc-services">https://www.f5.com/company/blog/nginx/deploying-nginx-plus-as-an-api-gateway-part-3-publishing-grpc-services</a></p>
<p><strong>NGINX as an API gateway</strong></p>
<p>To answer these aspects, I could not propose a better guide than the one you
can find in the references, written by Liam Crilly. The following is the
article’s table of content, curated to remove NGINX+ specific content as it is
not covered by the certification.</p>
<ul class="simple">
<li>Configuring the API gateway<ul>
<li>Introducing the Warehouse API</li>
<li>Organizing the NGINX Configuration</li>
<li>Defining the Top-Level API Gateway</li>
<li>Single-Service vs. Microservice API Backends</li>
<li>Defining the Warehouse API<ul>
<li>Choosing Broad vs. Precise Definition for APIs</li>
<li>Rewriting Client Requests to Handle Breaking Changes</li>
</ul>
</li>
<li>Responding to Errors</li>
<li>Implementing Authentication<ul>
<li>API Key Authentication</li>
</ul>
</li>
</ul>
</li>
<li>Protecting backend services<ul>
<li>Rate Limiting</li>
<li>Enforcing Specific Request Methods</li>
<li>Applying Fine-Grained Access Control<ul>
<li>Controlling Access to Specific Resources</li>
<li>Controlling Access to Specific Methods</li>
<li>Controlling Request Sizes</li>
<li>Validating Request Bodies</li>
<li>A Note about the <code class="docutils literal notranslate"><span class="pre">$request_body</span></code> Variable</li>
</ul>
</li>
</ul>
</li>
<li>Publishing gRPC Services<ul>
<li>Defining the gRPC Gateway</li>
<li>Running Sample gRPC Services<ul>
<li>Routing gRPC Requests</li>
<li>Precise Routing</li>
</ul>
</li>
<li>Responding to Errors</li>
<li>Authenticating Clients with gRPC Metadata</li>
<li>Applying Rate Limiting and Other API Gateway Controls</li>
</ul>
</li>
</ul>
<p>These constitute an excellent recipe for configuring NGINX as an API gateway.
Of course not all elements need to be applied, and some elements may already be
performed by the application (controlling the body content), but this recipe
shows how to take any app (even a legacy or lazy one) and configure a secure
and efficient API gateway.</p>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="objective-1-2-configure-nginx-as-a-content-cache-server">
<h2>Objective - 1.2 Configure NGINX as a content cache server<a class="headerlink" href="#objective-1-2-configure-nginx-as-a-content-cache-server" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<div class="section" id="define-a-minimum-retention-policy">
<h3>1.2 - Define a minimum retention policy<a class="headerlink" href="#define-a-minimum-retention-policy" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://blog.nginx.org/blog/nginx-caching-guide">https://blog.nginx.org/blog/nginx-caching-guide</a></p>
<p><a class="reference external" href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path">https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path</a></p>
<p><strong>Minimum retention policy</strong></p>
<p>When speaking of a caching system, a minimum retention policy refers to the
minimum time an element is accessible from a cached location. Concretely,
imagine we cache the content served from the upstream server at endpoint
<cite>http://upstream/data/1</cite>. A minimum retention policy defines the minimum time
(m seconds) NGINX would keep the cached version of the upstream’s response: we
would be sure to always have the cached version for m seconds after the initial
cache insertion.</p>
<p><strong>NGINX cache minimum retention</strong></p>
<p><em>TODO</em> (I can’t see how to do this, I see a maximum cache retention through the
<code class="docutils literal notranslate"><span class="pre">inactive=time</span></code> directive, but to me files can always be quickly evicted from
cache if they are not hit often enough and many other cache write are coming)</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="describe-how-to-configure-path-regex-routing">
<span id="module2-configure-routing"></span><h3>1.2 - Describe how to configure path REGEX routing<a class="headerlink" href="#describe-how-to-configure-path-regex-routing" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://www.f5.com/company/blog/nginx/regular-expression-tester-nginx">https://www.f5.com/company/blog/nginx/regular-expression-tester-nginx</a></p>
<p><a class="reference external" href="https://nginx.org/en/docs/http/ngx_http_core_module.html#location">https://nginx.org/en/docs/http/ngx_http_core_module.html#location</a></p>
<p><a class="reference external" href="https://nginx.org/en/docs/http/request_processing.html">https://nginx.org/en/docs/http/request_processing.html</a></p>
<p><strong>URI routing in NGINX</strong></p>
<p>When NGINX receives a request, it first tries to find a matching <code class="docutils literal notranslate"><span class="pre">server</span> <span class="pre">{}</span></code>
block to send the request to. Once this is done, NGINX processes the request’s
URI to find a matching <code class="docutils literal notranslate"><span class="pre">location</span> <span class="pre">{}</span></code> block among the one in the matched
server. This process is crucial and very error-prone, the reader must
familiarize with the location matching process to prevent errors. The matching
process is described as follows:</p>
<blockquote>
<div><p>The matching is performed against a normalized URI, after decoding the text
encoded in the “%XX” form, resolving references to relative path components
“.” and “..”, and possible compression of two or more adjacent slashes into a
single slash.</p>
<p>A location can either be defined by a prefix string, or by a regular
expression. Regular expressions are specified with the preceding “~*”
modifier (for case-insensitive matching), or the “~” modifier (for
case-sensitive matching). To find location matching a given request, nginx
first checks locations defined using the prefix strings (prefix locations).
Among them, the location with the longest matching prefix is selected and
remembered. Then regular expressions are checked, in the order of their
appearance in the configuration file. The search of regular expressions
terminates on the first match, and the corresponding configuration is used.
If no match with a regular expression is found then the configuration of the
prefix location remembered earlier is used.</p>
<p>Location blocks can be nested, with some exceptions mentioned below.</p>
<p>For case-insensitive operating systems such as macOS and Cygwin, matching
with prefix strings ignores a case (0.7.7). However, comparison is limited to
one-byte locales.</p>
<p>Regular expressions can contain captures (0.7.40) that can later be used in
other directives.</p>
<p>If the longest matching prefix location has the “^~” modifier then regular
expressions are not checked.</p>
<p>Also, using the “=” modifier it is possible to define an exact match of URI
and location. If an exact match is found, the search terminates. For example,
if a “/” request happens frequently, defining “location = /” will speed up
the processing of these requests, as search terminates right after the first
comparison. Such a location cannot obviously contain nested locations.</p>
</div></blockquote>
<p>Shortening this description is error-prone, therefore we advise familiarizing
with it. The following points can be surprising:</p>
<ul class="simple">
<li>By default, a REGEX match supersedes a prefix match (irrelevantly of the
length of the match)</li>
<li>Options “=” and “^~” disable the checking of REGEX matches</li>
<li>The first matched REGEX stops the matching check process: the order matters
and there is not such thing as longest matched REGEX (fortunately so)</li>
</ul>
<p>Among other points. The referenced [blog
post](<a class="reference external" href="https://www.f5.com/company/blog/nginx/regular-expression-tester-nginx">https://www.f5.com/company/blog/nginx/regular-expression-tester-nginx</a>)
from Rick Nelson gathers interesting examples and an explanation for a tester
software you can run to check which routes match a given REGEX location. Check
examples from the NGINX documentation to familiarize with REGEX and locations
definitions in NGINX.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="describe-the-why-and-how-of-caching-in-nginx">
<h3>1.2 - Describe the why and how of caching in NGINX<a class="headerlink" href="#describe-the-why-and-how-of-caching-in-nginx" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://docs.nginx.com/nginx/admin-guide/content-cache/content-caching/">https://docs.nginx.com/nginx/admin-guide/content-cache/content-caching/</a></p>
<p>Kapranoff, Nginx Troubleshooting, 82.</p>
<p><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html">http://nginx.org/en/docs/http/ngx_http_proxy_module.html</a></p>
<p><strong>Caching reduces load and speeds up</strong></p>
<p>The main reasons why one would like to cache in NGINX in because NGINX presents
the advantage of being an intermediate between the client and the upstream
servers. This leads to the following advantages:</p>
<ul class="simple">
<li>Caching at NGINX reduces load on the backend servers by processing and
serving some requests without having to re-ask the upstream to do it.</li>
<li>Caching at NGINX speeds up the response process as there are fewer
intermediates that need to be contacted to answer the client’s request
(everything between NGINX and the backend server is not involved when serving
a cached response).</li>
</ul>
<p><strong>How does NGINX enable caching</strong></p>
<p>There are different ways to ensure the served web content gets cached with
NGINX. We will here focus on the literal sense of using NGINX “as a caching
server”; namely, we will see how to make NGINX being the node serving cached
content in the web content retrieval process. Nonetheless, when engineering
your caching system, do not forget that you can make use (and use NGINX’s
capabilities to do so) of the HTTP headers such as <code class="docutils literal notranslate"><span class="pre">Cache-Control</span></code>. But this
makes web client become the caching actors, and we may want to get more control
on cached content by making it closer to the upstream servers. This is where
NGINX comes in handy.</p>
<p>Enabling caching on NGINX means making NGINX storing the content obtained from
the upstream servers to serve it later, when an “identical” requests comes in,
without having to contact the upstream server. This raises two interesting
points that we will immediately answer:</p>
<ul class="simple">
<li>Where is this content cached?<ul>
<li>The content gets cached on the NGINX host’s file system, at the path
specified with the <code class="docutils literal notranslate"><span class="pre">proxy_cache_path</span></code> directive. Generally, this means it
gets stored on the disk of the machine where NGINX is hosted. Nonetheless,
it is absolutely compatible with systems having other kinds of storage
mounted on the filesystem (you could mount a NFS or RAMFS endpoints and
store the cache there). Note that this is where the actual cache content
(HTML, JSON, or any web result returned by the upstream server to be sent
to the client). Caching in NGINX also involves cache keys that are
discussed in the next point.</li>
</ul>
</li>
<li>When does NGINX know how to serve cached content and when the request should
be forwarded to upstream?<ul>
<li>When NGINX performs content caching and receives a new request, it must
decide between “forwarding the request to upstream” or “hitting cache and
serving what I cached earlier”. Of course the algorithm to decide on this
is more complex that what we will explain, but the idea stays the same.
NGINX uses under the hood hash tables to map requests to cached content.
Therefore, to know if cached content already exists for some kind of
request, it will see if the request’s key matches an existing value. The
keys are stored in a shared memory zone defines with the
<code class="docutils literal notranslate"><span class="pre">proxy_cache_path</span></code> directive. The <code class="docutils literal notranslate"><span class="pre">proxy_cache_key</span></code> directives helps to
define what NGINX considers as two identical requests. By default, requests
with the same <code class="docutils literal notranslate"><span class="pre">$scheme$proxy_host$uri$is_args$args</span></code> are considered
identical and get served the same cached content. Otherwise, if not
matching value is found or if the cached content is stale, NGINX will
forward the request to an upstream server.</li>
</ul>
</li>
</ul>
<p>These are the basics of how NGINX allows to cache the content when placed as a
reverse proxy: it stores in its own file system the files served by upstream to
client, and tries to match incoming requests with the cached ones, serving the
cached ones when possible.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="define-the-cache-in-the-http-context">
<span id="module2-define-cache"></span><h3>1.2 - Define the cache in the http context<a class="headerlink" href="#define-the-cache-in-the-http-context" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://docs.nginx.com/nginx/admin-guide/content-cache/content-caching/">https://docs.nginx.com/nginx/admin-guide/content-cache/content-caching/</a></p>
<p><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path">http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path</a></p>
<p><strong>Simple cache definition in http context</strong></p>
<p>Although many configurations are possible, quickly getting started with NGINX
default cache is as simple as defining a <code class="docutils literal notranslate"><span class="pre">proxy_cache_path</span></code> directive in the
<code class="docutils literal notranslate"><span class="pre">http</span> <span class="pre">{}</span></code> context, along with the <code class="docutils literal notranslate"><span class="pre">proxy_cache</span></code> directive in the context
where you want to have caching (a whole server, a location, etc.).</p>
<p>The following gives a quick example:</p>
<div class="highlight-NGINX notranslate"><div class="highlight"><pre><span></span><span class="k">http</span> <span class="p">{</span>
    <span class="c1"># ...</span>
    <span class="kn">proxy_cache_path</span> <span class="s">/data/nginx/cache</span> <span class="s">keys_zone=mycache:10m</span><span class="p">;</span>
    <span class="kn">server</span> <span class="p">{</span>
        <span class="kn">proxy_cache</span> <span class="s">mycache</span><span class="p">;</span>
        <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
            <span class="kn">proxy_pass</span> <span class="s">http://localhost:8000</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This defines content caching where cached files are stored in the file system
at <code class="docutils literal notranslate"><span class="pre">/data/nginx/cache</span></code>, and cache keys are stored in a shared memory zone
named <code class="docutils literal notranslate"><span class="pre">mycache</span></code>, a zone of 10 megabytes.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Although this is not directly linked to this evaluation point, please note
the following: by default the cache keys quite matches the following 5-tuple
<code class="docutils literal notranslate"><span class="pre">$scheme$proxy_host$uri$is_args$args</span></code>. This means that 2 users querying
<code class="docutils literal notranslate"><span class="pre">https://example.com/myprofile</span></code> should, in the eyes of NGINX, be served the
same cached content. If Bob’s profile is loaded in the cache, then Alice’s
request will be served the same cached content page that could contain
sensible information. To avoid this, defining new cache keys such as
<code class="docutils literal notranslate"><span class="pre">$host$request_uri$cookie_user</span></code> could prevent this issue, assuming you have
an authentication session cookie named USER and your endpoint is
authenticated through this cookie. Indeed, Alice and Bob’s cookies will not
match and therefore, the requests will not be considered identical.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="enable-the-cache">
<h3>1.2 - Enable the cache<a class="headerlink" href="#enable-the-cache" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="#module2-define-cache"><span class="std std-ref">previous part</span></a> basically covers this. The
caching is actually enabled through the <code class="docutils literal notranslate"><span class="pre">proxy_cache</span></code> directive which makes
responses from a given context actually cached.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="specify-the-content-that-should-be-cached">
<h3>1.2 - Specify the content that should be cached<a class="headerlink" href="#specify-the-content-that-should-be-cached" title="Permalink to this headline">¶</a></h3>
<p>Kapranoff, Nginx Troubleshooting, 82.</p>
<p><strong>When caching gets most useful</strong></p>
<p>This question is of course open-ended. However, the caching algorithm is best
when optimizing the following aspects:</p>
<ul class="simple">
<li>The cached content should not change often and be long-lived static.
Otherwise you would often have to re-populate your cache or worse, serve
stale content when it is not desired.</li>
<li>The cached content should be the one queried often. Indeed, you do not want
to use memory resources for content that is useful to a very few users.</li>
</ul>
<p>Therefore, the answer to “what should be cached” may vary on your application,
however, some files often match these criteria in many case static files such
as style sheets or static scripts that are required upon every request and
generally are not updated on any release (or at least, serving stale style
might still allow your service to function and occur minimal impact).</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="describe-different-types-of-caching">
<h3>1.2 - Describe different types of caching<a class="headerlink" href="#describe-different-types-of-caching" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="module1.html#module1-describe-nginx-caching"><span class="std std-ref">previous module</span></a> already goes
through details on different types of caching along with references on the
topic.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="explain-what-is-unique-to-nginx-as-a-cache-server">
<h3>1.2 - Explain what is unique to NGINX as a cache server<a class="headerlink" href="#explain-what-is-unique-to-nginx-as-a-cache-server" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path">http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path</a></p>
<p><strong>Interests of caching at the reverse proxy layer</strong></p>
<p>In the same idea as “what is unique to NGINX” as a load balancer, we, among
other things, find NGINX’s uniqueness in its interesting position on the path
between clients and upstream servers. Indeed, caching at the reverse proxy has
both advantages:</p>
<ul class="simple">
<li>It effectively reduces load on the backend servers, as a cache hit results in
the server not being queried. This can be done with zero modification of the
upstream server’s code which may be handy when dealing with legacy or
non-controllable applications.</li>
<li>It leaves control in your hands. A disadvantage of caching on the clients’
devices is that if you make a mistake (setting a client cache time limit too
high for example), clients may be left with stale data and wrongly not
re-emit requests to your servers. Having NGINX caching allows you, as an
admin, tu purge caches if needed and control it on your end.</li>
</ul>
<p><strong>Optimized and controllable caching</strong></p>
<p>The above is true for any caching implemented by a reverse proxy. NGINX is
particularly good because it comes with great optimizations (e.g.: the caching
keys are stored in a shared memory zone, this is non-trivial and allows to
share the cache population work performed by the different workers and leverage
hardware with high parallelism capabilities) that are very easy to configure
out of the box.</p>
<p>On another hands, I think it is important to speak about the controllability
you get when caching with NGINX. Notably, you should visit the documentation
page about <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path">proxy_cache_path</a>
directive. You can for example define parameters on how and when to purge
files, along with directives controlling how should concurrent workers fetching
a cacheable data behave. This allows you to define your own thresholds between
serving cached data at all cost or just using cache as a circumstantial
performance bonus, depending on your business needs.</p>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="objective-1-3-configure-nginx-as-a-web-server">
<h2>Objective - 1.3 Configure NGINX as a web server<a class="headerlink" href="#objective-1-3-configure-nginx-as-a-web-server" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<div class="section" id="demonstrate-how-to-securely-serve-content-http-https">
<h3>1.3 - Demonstrate how to securely serve content (HTTP/HTTPS)<a class="headerlink" href="#demonstrate-how-to-securely-serve-content-http-https" title="Permalink to this headline">¶</a></h3>
<p>DEJONGHE, NGINX COOKBOOK Advanced Recipes for High -Performance Load
Balancing., 77, 84-88.</p>
<p><a class="reference external" href="https://nginx.org/en/docs/http/configuring_https_servers.html">https://nginx.org/en/docs/http/configuring_https_servers.html</a></p>
<p><a class="reference external" href="https://docs.nginx.com/nginx/admin-guide/security-controls/">https://docs.nginx.com/nginx/admin-guide/security-controls/</a></p>
<p>Kapranoff, Nginx Troubleshooting, 117.</p>
<p><a class="reference external" href="https://www.cyberciti.biz/tips/linux-unix-bsd-nginx-webserver-security.html">https://www.cyberciti.biz/tips/linux-unix-bsd-nginx-webserver-security.html</a></p>
<p><a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy</a></p>
<p><a class="reference external" href="https://blog.nginx.org/blog/http-strict-transport-security-hsts-and-nginx">https://blog.nginx.org/blog/http-strict-transport-security-hsts-and-nginx</a></p>
<p><strong>General security aspects</strong></p>
<p>The <a class="reference internal" href="#module2-describe-configure-security"><span class="std std-ref">previous part</span></a> already gives
insights on what settings can be adjusted to control security aspects of an
HTTP/HTTPS server. Security of course is a tremendously vast topic and we could
not cover it all in this point. We will try to cover the most important aspects
and, as the objective asks for demonstrative capabilities, mostly provide
detailed examples of concrete security configurations.</p>
<p><strong>Authentication</strong></p>
<p>NGINX OSS proposes 2 ways to authenticate requests and protect locations based
on authentication + authorization rules: HTTP Basic authentication and
sub-request results. You will find more details on this in :ref:` module 3
&lt;module3 demonstrate authenticate&gt;`.</p>
<p><strong>Client-Reverse Proxy flux security</strong></p>
<p>Securing the connection between the connecting client and NGINX can be achieved
with the various capabilities for setting up NGINX as an HTTPS server. You will
find more details on this point in <a class="reference internal" href="module3.html#module3-configure-certificates"><span class="std std-ref">module 3</span></a>.</p>
<p><strong>Reverse Proxy-Upstream servers security</strong></p>
<p>In order to make sure the communication between NGINX and the upstream servers
is secured, one can configure HTTPS communication between NGINX and the
upstream server when proxy passing the requests. The following example shows
how to do it:</p>
<div class="highlight-NGINX notranslate"><div class="highlight"><pre><span></span><span class="k">location</span> <span class="s">/</span> <span class="p">{</span>
  <span class="kn">proxy_pass</span> <span class="s">https://upstream.example.com</span><span class="p">;</span>
  <span class="kn">proxy_ssl_verify</span> <span class="no">on</span><span class="p">;</span>
  <span class="kn">proxy_ssl_protocols</span> <span class="s">TLSv1.3</span><span class="p">;</span>

  <span class="kn">proxy_ssl_certificate</span>     <span class="s">/etc/nginx/client.pem</span><span class="p">;</span>
  <span class="kn">proxy_ssl_certificate_key</span> <span class="s">/etc/nginx/client.key</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">proxy_pass</span></code> directive uses the <code class="docutils literal notranslate"><span class="pre">https</span></code> scheme, which enables
HTTPS with the upstream. The <code class="docutils literal notranslate"><span class="pre">proxy_ssl_verify</span></code> directive is set to <code class="docutils literal notranslate"><span class="pre">on</span></code> to
make sure that NGINX verifies the upstream server’s certificate (<a class="reference external" href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_ssl_verify">by default</a>,
this is set to <code class="docutils literal notranslate"><span class="pre">off</span></code>). The <code class="docutils literal notranslate"><span class="pre">proxy_ssl_protocols</span></code> limits the accepted TLS
version to be used to negotiate the TLS communication.</p>
<p>On another hand, the <code class="docutils literal notranslate"><span class="pre">proxy_ssl_certificate</span></code> and
<code class="docutils literal notranslate"><span class="pre">proxy_ssl_certificate_key</span></code> define the certificate and key to be used by
NGINX for setting up a mTLS communication with the upstream server. Indeed, by
default, only the upstream server must authenticate with its certificate toward
NGINX. With both these directives, NGINX presents its own certificate to the
upstream server to ensure the upstream can authenticate the reverse proxy,
which could be used to perform authorization decisions.</p>
<p><strong>IP based protections</strong></p>
<p>When a client connects to NGINX, their IP address is retrieved and can be used
by NGINX to enforce restrictions based on different rules (geoIP, manually
defined decisions, etc.). <a class="reference internal" href="module3.html#module3-restrict-ip"><span class="std std-ref">Module 3</span></a> goes further
into details on how to restrict access based on IP addresses.</p>
<p><strong>HTTP specific security features</strong></p>
<p>HTTP and its evolution comes with many specifications, headers and other quirks
dedicated to security. We could not go over all of them, but it is worth
mentioning some common hardening features allowed by NGINX. Ideally, the
upstream servers should be able to define the correct HTTP headers to ensure
secure content delivery: the upstream is the most tightly intertwined with the
application logic, it knows what content should be allowed and how. However,
the power of NGINX is its ability to cope with upstream server not able to add
such security options.</p>
<dl class="docutils">
<dt>Secure Cross-Origin Resources Sharing (CORS)</dt>
<dd><p class="first">The following diagram from <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/http/CORS">Mozilla’s documentation</a> presents what is
meant by CORS and when it occurs.</p>
<a class="reference internal image-reference" href="../../_images/cors_principle.png"><img alt="Diagram presenting CORS principle" src="../../_images/cors_principle.png" style="height: 500px;" /></a>
<p>Basically, if your server serves resources from another domain (say, you host
images or scripts used as resources for pages in a websites hosted at
<code class="docutils literal notranslate"><span class="pre">site1.example.com</span></code> and <code class="docutils literal notranslate"><span class="pre">site2.example.com</span></code>), you will need to enable
CORS for the web clients to be able to fetch the resources you host that are
referred to in the pages served by <code class="docutils literal notranslate"><span class="pre">site1.example.com</span></code> and
<code class="docutils literal notranslate"><span class="pre">site2.example.com</span></code>.</p>
<div class="last highlight-NGINX notranslate"><div class="highlight"><pre><span></span><span class="k">map</span> <span class="nv">$request_method</span> <span class="nv">$cors_method</span> <span class="p">{</span>
  <span class="kn">OPTIONS</span> <span class="mi">11</span><span class="p">;</span>
  <span class="kn">GET</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kn">POST</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kn">default</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">server</span> <span class="p">{</span>
  <span class="c1"># ...</span>
  <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
    <span class="kn">if</span> <span class="s">(</span><span class="nv">$cors_method</span> <span class="p">~</span> <span class="sr">&#39;1&#39;)</span> <span class="p">{</span>
    <span class="kn">add_header</span> <span class="s">&#39;Access-Control-Allow-Methods&#39;</span>
      <span class="s">&#39;GET,POST,OPTIONS&#39;</span><span class="p">;</span>
    <span class="kn">add_header</span> <span class="s">&#39;Access-Control-Allow-Origin&#39;</span>
      <span class="s">&#39;*.example.com&#39;</span><span class="p">;</span>
    <span class="kn">add_header</span> <span class="s">&#39;Access-Control-Allow-Headers&#39;</span>
      <span class="s">&#39;DNT,</span> <span class="s">Keep-Alive,</span> <span class="s">User-Agent,</span> <span class="s">X-Requested-With,</span> <span class="s">If-Modified-Since,</span> <span class="s">Cache-Control,</span> <span class="s">Content-Type&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">if</span> <span class="s">(</span><span class="nv">$cors_method</span> <span class="p">=</span> <span class="s">&#39;11&#39;)</span> <span class="p">{</span>
      <span class="kn">add_header</span> <span class="s">&#39;Access-Control-Max-Age&#39;</span> <span class="mi">1728000</span><span class="p">;</span>
      <span class="kn">add_header</span> <span class="s">&#39;Content-Type&#39;</span> <span class="s">&#39;text/plain</span><span class="p">;</span> <span class="kn">charset=UTF-8&#39;</span><span class="p">;</span>
      <span class="kn">add_header</span> <span class="s">&#39;Content-Length&#39;</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kn">return</span> <span class="mi">204</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</dd>
<dt>Clickjacking and Cross-Site Scripting (XSS) protection</dt>
<dd>Clickjacking refers to an attack where a user is tricked into clicking on a
link from a different source that what they think (for example, clicking on a
“Submit” button inside an iFrame when they think the button belongs to the
top level page and not an iFrame). XSS is is a security exploit which allows
an attacker to inject into a website malicious client-side code. This code is
executed by the victims and lets the attackers bypass access controls and
impersonate users. HTTP proposes the standardized <strong>Content-Security-Policy</strong>
header to solve these. This one consists of directives where the client
receives indication as of which resources are allowed to be fetched from
where. The <code class="docutils literal notranslate"><span class="pre">add_header</span> <span class="pre">Content-Security-Policy</span> <span class="pre">&quot;&lt;directive&gt;</span> <span class="pre">&lt;value&gt;;&quot;;</span></code>
NGINX directive allows setting up this header on HTTP responses served to the
client. The reader is advised to dig deeper in this topic by looking at
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy">documentation</a>
and <a class="reference external" href="https://content-security-policy.com/examples/nginx/">examples</a>.</dd>
<dt>HTTP Strict Transport Security</dt>
<dd>HTTP Strict Transport Security is an HTTP header indicating to a web client
that the host it contacted must be contacted through HTTPS only, and caches
this information for a certain (generally long) amount of time. This reduces
the attack surface available for an attacker in the middle aiming to
intercept initial plain HTTP requests and impersonate these. Indeed, after
this header is received once, the client is protected and knows that at least
for <code class="docutils literal notranslate"><span class="pre">max-age</span></code> seconds that a plain HTTP response is suspicious and should
not be trusted. In order to ensure this, NGINX can, with the directive
<code class="docutils literal notranslate"><span class="pre">add_header</span> <span class="pre">Strict-Transport-Security</span> <span class="pre">“max-age=31536000;</span> <span class="pre">includeSubDomains”</span>
<span class="pre">always;</span></code>, add the HTTP Strict-Transport-Security header to all responses
sent back to the client.</dd>
</dl>
<p><strong>Location security and secure links</strong></p>
<p>In order to protect a location, NGINX can make use of the features in its
<a class="reference external" href="https://nginx.org/en/docs/http/ngx_http_secure_link_module.html">ngx_http_secure_link_module</a>.</p>
<p>Basically, this module allows to protect a location by requiring the requested
URI contains some non easily guessable value, making it hard for automated
scanner to easily access the files at that location.</p>
<p>This can be implemented by 2 different modes: The first mode is enabled by the
<code class="docutils literal notranslate"><span class="pre">secure_link_secret</span></code> directive and is used to check authenticity of requested
links as well as protect resources from unauthorized access. The second mode
(0.8.50) is enabled by the <code class="docutils literal notranslate"><span class="pre">secure_link</span></code> and <code class="docutils literal notranslate"><span class="pre">secure_link_md5</span></code> directives
and is also used to limit lifetime of links.</p>
<p>The following configuration makes use of the <code class="docutils literal notranslate"><span class="pre">secure_link_secret</span></code> directive:</p>
<div class="highlight-NGINX notranslate"><div class="highlight"><pre><span></span><span class="k">location</span> <span class="s">/resources</span> <span class="p">{</span>
  <span class="kn">secure_link_secret</span> <span class="s">mySecret</span><span class="p">;</span>
  <span class="kn">if</span> <span class="s">(</span><span class="nv">$secure_link</span> <span class="p">=</span> <span class="s">&quot;&quot;)</span> <span class="p">{</span> <span class="kn">return</span> <span class="mi">403</span><span class="p">;</span> <span class="p">}</span>
  <span class="kn">rewrite</span> <span class="s">^</span> <span class="s">/secured/</span><span class="nv">$secure_link</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">location</span> <span class="s">/secured/</span> <span class="p">{</span>
  <span class="kn">internal</span><span class="p">;</span>
  <span class="kn">root</span> <span class="s">/var/www</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In order to make use of a secure link, one must place the files to be protected
inside the <code class="docutils literal notranslate"><span class="pre">/var/www/secured</span></code> folder. With this in place, accessing, for
example, the <code class="docutils literal notranslate"><span class="pre">/var/www/secured/index.html</span></code> file would require using the
following URL:
<code class="docutils literal notranslate"><span class="pre">your.server.url/resources/a53bee08a4bf0bbea978ddf736363a12/index.html</span></code>. Here
is what happens when this request is received by NGINX:</p>
<ul class="simple">
<li>NGINX matches the location <code class="docutils literal notranslate"><span class="pre">/resources</span></code> from its configuration</li>
<li>It discovers this location is protected by a secret, as of the presence of
the <code class="docutils literal notranslate"><span class="pre">secure_link_secret</span></code> directive.</li>
<li>It takes the secret word (in that case, <code class="docutils literal notranslate"><span class="pre">mySecret</span></code>) and the remaining of
the accessed URI (in that case, <code class="docutils literal notranslate"><span class="pre">index.html</span></code>), concatenates those and
hashes it with the MD5 procedure. In bash, you could perform this operation
with the following code:</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> -n <span class="s1">&#39;index.htmlmySecret&#39;</span> <span class="p">|</span> openssl md5 -hex
</pre></div>
</div>
<ul class="simple">
<li>If the computed hash matches the string between <code class="docutils literal notranslate"><span class="pre">resources/</span></code> and
<code class="docutils literal notranslate"><span class="pre">/index.html</span></code> in the URI, it proceeds, otherwise it returns a 403 error.</li>
<li>After validating the URI, NGINX can <code class="docutils literal notranslate"><span class="pre">rewrite</span></code> the URI by replacing it (from
the beginning, per the <code class="docutils literal notranslate"><span class="pre">^</span></code> argument) by another location’s prefix (in that
case, <code class="docutils literal notranslate"><span class="pre">/secured/</span></code>) and appending the content of the <code class="docutils literal notranslate"><span class="pre">$secure_link</span></code>
variable. This variable contains, if the validation failed, an empty string,
and if the validation succeeded, the remaining of the URI after the hash (in
that case, <code class="docutils literal notranslate"><span class="pre">index.html</span></code>).</li>
<li>Making the location <code class="docutils literal notranslate"><span class="pre">/secured/</span></code> internal, only NGINX generated requests
(through internal redirects) can access it. Therefore, thanks to the above
<code class="docutils literal notranslate"><span class="pre">rewrite</span></code> directive, only secure links can reach the files located in the
secure folder, and the client accessing
<code class="docutils literal notranslate"><span class="pre">your.server.url/resources/a53bee08a4bf0bbea978ddf736363a12/index.html</span></code> can
in the end be served the file stored at <code class="docutils literal notranslate"><span class="pre">/var/www/secured/index.html</span></code>.</li>
</ul>
<p>Using the <code class="docutils literal notranslate"><span class="pre">secure_link</span></code> and <code class="docutils literal notranslate"><span class="pre">secure_link_md5</span></code> directives follows the same
general idea but with more control over some aspects of the link, notably
allowing to define an expiration date for example. The module documentation
covers it in more details.</p>
<p><strong>Logging</strong></p>
<p>Logging the important information of received requests is crucial to configure
your server’s security. This topic is covered in more details in <a class="reference internal" href="module3.html#module3-configure-logging"><span class="std std-ref">Module 3</span></a>.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="describe-the-difference-between-serving-static-content-and-dynamic-content-regex-and-variables">
<h3>1.3 - Describe the difference between serving static content and dynamic content. (REGEX, and variables)<a class="headerlink" href="#describe-the-difference-between-serving-static-content-and-dynamic-content-regex-and-variables" title="Permalink to this headline">¶</a></h3>
<p>This objective’s phrasing is quite weird: dynamic vs. static content clearly,
in the context of the web, refer to webpages that may have automated evolutions
and some logic (NodeJS or PHP web stack), while static content should remain
statically generated, independently of the requests. On another hand, the
parenthesis and sub-objectives go totally in another direction, talking about
NGINX’s location matching mechanisms. The following <a class="reference external" href="https://nginxcommunity.slack.com/archives/C071Y9G3L3T/p1720767284864229">link</a>
points to a discussion on this subject that you may find enlightening or not.</p>
<p>To answer both aspects:</p>
<ul class="simple">
<li>NGINX supports dynamic URI matching. This means that the configuration file
does not have to write one by one all possible URIs that a server should
answer to, but performs some smart matching potentially using REGEX and
variables. This is notably what we discussed in <cite>1.2 - Describe how to
configure path REGEX routing &lt;module2 configure routing&gt;</cite>.</li>
<li>NGINX can act both as a static content server, and a dynamic content reverse
proxy. NGINX serves static files using the <code class="docutils literal notranslate"><span class="pre">root</span></code>, <code class="docutils literal notranslate"><span class="pre">index</span></code> and
<code class="docutils literal notranslate"><span class="pre">try_files</span></code> directives we already encountered. On another hand, the
<code class="docutils literal notranslate"><span class="pre">proxy_pass</span></code> family of directives allows NGINX to reverse proxy connections
to upstream servers generating dynamic content. NGINX even has optimized
proxy passing for certain protocols such as FastCGI with the
<cite>ngx_http_fastcgi_module
&lt;https://nginx.org/en/docs/http/ngx_http_fastcgi_module.html&gt;</cite> and its
<code class="docutils literal notranslate"><span class="pre">fastcgi_pass</span></code> directive.</li>
</ul>
<p>The difference between both is that:</p>
<ul class="simple">
<li>static file’s content should not be different between 2 requests. The content
should only evolve if someone replaces the files at the location they are
being served from on the machine hosting NGINX.</li>
<li>dynamic content is expected to serve different files between 2 requests. This
can for example be implemented with the PHP programming language that can
read a request and a <code class="docutils literal notranslate"><span class="pre">.php</span></code> file to be served, and perform dynamic actions
to make the page evolve depending on request’s parameters (e.g.:
Authorization, User-Agent or Cookie headers), or even depending on other
aspects (e.g.: the time at which the request is processed)</li>
</ul>
<p>NGINX has features for handling both aspects.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="describe-how-server-and-location-work">
<h3>1.3 - Describe how server and location work<a class="headerlink" href="#describe-how-server-and-location-work" title="Permalink to this headline">¶</a></h3>
<p>For this objective, if you are already comfortable with the previous part you
should have a better idea on how to tackle this.</p>
<p>It however can be interesting to note the actual definition of server and
location blocks. First, note that the <code class="docutils literal notranslate"><span class="pre">server</span></code> directive belongs to both the
http and stream modules, while the <code class="docutils literal notranslate"><span class="pre">location</span></code> directive can only be found and
only makes sense in the http module (there is no notion of URI above the OSI
layer 7 where the HTTP protocol lies).</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="explain-what-is-unique-to-nginx-as-a-web-server">
<h3>1.3 - Explain what is unique to NGINX as a web server<a class="headerlink" href="#explain-what-is-unique-to-nginx-as-a-web-server" title="Permalink to this headline">¶</a></h3>
<p><em>TODO</em></p>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="objective-configure-nginx-as-a-reverse-proxy">
<h2>Objective - Configure NGINX as a reverse proxy<a class="headerlink" href="#objective-configure-nginx-as-a-reverse-proxy" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<div class="section" id="explain-how-traffic-routing-is-handled-in-nginx-as-a-reverse-proxy">
<h3>1.4 - Explain how traffic routing is handled in NGINX as a reverse proxy<a class="headerlink" href="#explain-how-traffic-routing-is-handled-in-nginx-as-a-reverse-proxy" title="Permalink to this headline">¶</a></h3>
<p><em>TODO</em></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="explain-what-is-unique-to-nginx-as-a-reverse-proxy">
<h3>1.4 - Explain what is unique to NGINX as a reverse proxy<a class="headerlink" href="#explain-what-is-unique-to-nginx-as-a-reverse-proxy" title="Permalink to this headline">¶</a></h3>
<p><em>TODO</em></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="configure-encryption">
<h3>1.4 - Configure encryption<a class="headerlink" href="#configure-encryption" title="Permalink to this headline">¶</a></h3>
<p><em>TODO</em></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="demonstrate-how-to-manipulate-headers">
<h3>1.4 - Demonstrate how to manipulate headers<a class="headerlink" href="#demonstrate-how-to-manipulate-headers" title="Permalink to this headline">¶</a></h3>
<p><em>TODO</em></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="describe-the-difference-between-proxy-set-header-and-add-header">
<h3>1.4 - Describe the difference between proxy_set_header and add_header<a class="headerlink" href="#describe-the-difference-between-proxy-set-header-and-add-header" title="Permalink to this headline">¶</a></h3>
<p><em>TODO</em></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id1">
<h3>1.4 - Modify or tune a memory zone configuration<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p><em>TODO</em></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="describe-how-to-configure-nginx-as-socket-reserve-proxy">
<h3>1.4 - Describe how to configure NGINX as socket reserve proxy<a class="headerlink" href="#describe-how-to-configure-nginx-as-socket-reserve-proxy" title="Permalink to this headline">¶</a></h3>
<p><em>TODO</em></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="describe-how-open-source-nginx-handles-health-checks-in-different-situations">
<h3>1.4 - Describe how open source NGINX handles health checks in different situations<a class="headerlink" href="#describe-how-open-source-nginx-handles-health-checks-in-different-situations" title="Permalink to this headline">¶</a></h3>
<p><em>TODO</em></p>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
</div>
</div>


     </div>
    
     <div class="row next-prev-btn-row">
       <div class="col-lg-12">
       
        <a href="module1.html" title="F5N1 - Management" accesskey="p" class="btn btn-primary left"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous</a>
       
       
          <a href="module3.html" title="F5N3 - Configuration: Demonstrate" accesskey="n" class="btn btn-primary right">Next <i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
       
     </div>
     </div>
    

    </article>
  </div>

</div>


  <div id="clouddocs-footer"></div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="../../_static/js/index.js"></script>
  <script src="../../_static/js/jquery.appear.js"></script>
  <script src="../../_static/js/printThis.js"></script>
  <script src="../../_static/js/bootstrap.min.js"></script>
  <script src="../../_static/js/clouddocs.js"></script>
  <script src="../../_static/js/CoveoJsSearch.Lazy.min.js"></script>
  </body>
</html>